.\" This manpage has been automatically generated by docbook2man 
.\" from a DocBook document.  This tool can be found at:
.\" <http://shell.ipoline.com/~elmert/comp/docbook2X/> 
.\" Please send any bug reports, improvements, comments, patches, 
.\" etc. to Steve Cheng <steve@ggi-project.org>.
.TH "GNT-CLUSTER" "8" "18 June 2010" "ganeti 2.0" ""

.SH NAME
gnt-cluster \- ganeti administration, cluster-wide
.SH SYNOPSIS

\fBgnt-cluster \fR \fBcommand\fR [ \fBarguments...\fR ]

.SH "DESCRIPTION"
.PP
The \fBgnt-cluster\fR is used for cluster-wide
administration in the ganeti system.
.SH "COMMANDS"
.SS "ADD-TAGS"

\fBadd-tags\fR [ \fB--from \fIfile\fB\fR ] \fB\fItag\fB\fR\fI ...\fR

.PP
Add tags to the cluster. If any of the tags contains invalid
characters, the entire operation will abort.
.PP
If the \fB--from\fR option is given, the list of
tags will be extended with the contents of that file (each
line becomes a tag). In this case, there is not need to pass
tags on the command line (if you do, both sources will be
used). A file name of - will be interpreted as stdin.
.SS "COMMAND"

\fBcommand\fR [ \fB-n \fInode\fB\fR ] \fB\fIcommand\fB\fR

.PP
Executes a command on all nodes. If the option
\fB-n\fR is not given, the command will be executed
on all nodes, otherwise it will be executed only on the
node(s) specified. Use the option multiple times for running
it on multiple nodes, like:

.nf
          # gnt-cluster command -n node1.example.com -n node2.example.com date
        
.fi
.PP
The command is executed serially on the selected nodes. If the
master node is present in the list, the command will be
executed last on the master. Regarding the other nodes, the
execution order is somewhat alphabetic, so that
node2.example.com will be earlier than node10.example.com but
after node1.example.com.
.PP
So given the node names node1, node2, node3, node10, node11,
with node3 being the master, the order will be: node1, node2,
node10, node11, node3.
.PP
The command is constructed by concatenating all other command
line arguments. For example, to list the contents of the
\fI/etc\fR directory on all
nodes, run:

.nf
          # gnt-cluster command ls -l /etc
        
.fi
and the command which will be executed will be
"ls -l /etc"
.SS "COPYFILE"

\fBcopyfile\fR [ \fB--use-replication-network\fR ] [ \fB-n \fInode\fB\fR ] \fB\fIfile\fB\fR

.PP
Copies a file to all or to some nodes. The argument specifies
the source file (on the current system), the
\fB-n\fR argument specifies the target node, or
nodes if the option is given multiple times. If
\fB-n\fR is not given at all, the file will be
copied to all nodes.
Passing the \fB--use-replication-network\fR option
will cause the copy to be done over the replication network
(only matters if the primary/secondary IPs are different).
Example:

.nf
          # gnt-cluster -n node1.example.com -n node2.example.com copyfile /tmp/test
        
.fi
This will copy the file \fI/tmp/test\fR from
the current node to the two named nodes.
.SS "DESTROY"

\fBdestroy\fR \fB--yes-do-it\fR

.PP
Remove all configuration files related to the cluster, so that
a \fBgnt-cluster init\fR can be done again
afterwards.
.PP
Since this is a dangerous command, you are required to pass
the argument \fI--yes-do-it.\fR
.SS "GETMASTER"

\fBgetmaster\fR

.PP
Displays the current master node.
.SS "INFO"

\fBinfo\fR [ \fB--roman\fR ]

.PP
Shows runtime cluster information: cluster name, architecture
(32 or 64 bit), master node, node list and instance list.
.PP
Passing the \fB--roman\fR option gnt-cluster info will try
to print its integer fields in a latin friendly way. This allows
further diffusion of Ganeti among ancient cultures.
.SS "INIT"

\fBinit\fR
    [ \fB-s \fIsecondary_ip\fB\fR ]
    [ \fB-g \fIvg-name\fB\fR ]
    [ \fB--master-netdev \fIvg-name\fB\fR ]
    [ \fB-m \fImac-prefix\fB\fR ]
    [ \fB--no-lvm-storage\fR ]
    [ \fB--no-etc-hosts\fR ]
    [ \fB--no-ssh-init\fR ]
    [ \fB--file-storage-dir \fIdir\fB\fR ]
    [ \fB--enabled-hypervisors \fIhypervisors\fB\fR ]
    [ \fB-t \fIhypervisor name\fB\fR ]
    [ \fB--hypervisor-parameters \fIhypervisor\fB:\fIhv-param\fB=\fIvalue\fB [ ,\fIhv-param\fB=\fIvalue\fB\fI ...\fB ]\fR ]
    [ \fB--backend-parameters \fIbe-param\fB=\fIvalue\fB [ ,\fIbe-param\fB=\fIvalue\fB\fI ...\fB ]\fR ]
    [ \fB--nic-parameters \fInic-param\fB=\fIvalue\fB [ ,\fInic-param\fB=\fIvalue\fB\fI ...\fB ]\fR ]
    [ \fB--maintain-node-health  { yes | no }\fR ]
    [ \fB--uid-pool \fIuser-id pool definition\fB\fR ]
    \fB\fIclustername\fB\fR

.PP
This commands is only run once initially on the first node of
the cluster. It will initialize the cluster configuration and
setup ssh-keys and more.
.PP
Note that the \fIclustername\fR is not
any random name. It has to be resolvable to an IP address
using DNS, and it is best if you give the fully-qualified
domain name. This hostname must resolve to an IP address
reserved exclusively for this purpose.
.PP
The cluster can run in two modes: single-home or
dual-homed. In the first case, all traffic (both public
traffic, inter-node traffic and data replication traffic) goes
over the same interface. In the dual-homed case, the data
replication traffic goes over the second network. The
\fB-s\fR option here marks the cluster as
dual-homed and its parameter represents this node's address on
the second network. If you initialise the cluster with
\fB-s\fR, all nodes added must have a secondary IP
as well.
.PP
Note that for Ganeti it doesn't matter if the secondary
network is actually a separate physical network, or is done
using tunneling, etc. For performance reasons, it's
recommended to use a separate network, of course.
.PP
The \fB-g\fR option will let you specify a volume group
different than 'xenvg' for ganeti to use when creating instance disks.
This volume group must have the same name on all nodes. Once the
cluster is initialized this can be altered by using the
\fBmodify\fR command. If you don't want to use lvm
storage at all use the \fB--no-lvm-storage\fR option.
Once the cluster is initialized you can change this setup with the
\fBmodify\fR command.
.PP
The \fB--master-netdev\fR option is useful for specifying a
different interface on which the master will activate its IP address.
It's important that all nodes have this interface because you'll need
it for a master failover.
.PP
The \fB-m\fR option will let you specify a three byte prefix
under which the virtual MAC addresses of your instances will be
generated. The prefix must be specified in the format XX:XX:XX and the
default is aa:00:00.
.PP
The \fB--no-lvm-storage\fR option allows you to initialize
the cluster without lvm support. This means that only instances using
files as storage backend will be possible to create. Once the cluster
is initialized you can change this setup with the
\fBmodify\fR command.
.PP
The \fB--no-etc-hosts\fR option allows you to initialize the
cluster without modifying the \fI/etc/hosts\fR file.
.PP
The \fB--no-ssh-init\fR option allows you to initialize the
cluster without creating or distributing SSH key pairs.
.PP
The \fB--file-storage-dir\fR option allows you
set the directory to use for storing the instance disk
files when using file storage as backend for instance disks.
.PP
The \fB--enabled-hypervisors\fR option allows you
to set the list of hypervisors that will be enabled for
this cluster. Instance hypervisors can only be chosen from
the list of enabled hypervisors, and the first entry of this list
will be used by default. Currently, the following hypervisors are
available:
.PP
.TP
\fBxen-pvm\fR
Xen PVM hypervisor
.TP
\fBxen-hvm\fR
Xen HVM hypervisor
.TP
\fBkvm\fR
Linux KVM hypervisor
.TP
\fBchroot\fR
a simple chroot manager that starts chroot based on a
script at the root of the filesystem holding the
chroot
.TP
\fBfake\fR
fake hypervisor for development/testing
.PP
Either a single hypervisor name or a comma-separated list of
hypervisor names can be specified. If this option is not
specified, only the xen-pvm hypervisor is enabled by default.
.PP
The \fB--hypervisor-parameters\fR option allows you
to set default hypervisor specific parameters for the
cluster. The format of this option is the name of the
hypervisor, followed by a colon and a comma-separated list of
key=value pairs. The keys available for each hypervisors are
detailed in the \fBgnt-instance\fR(8) man page, in the
\fBadd\fR command plus the following parameters
which are only configurable globally (at cluster level):
.TP
\fBmigration_port\fR
Valid for the Xen PVM and KVM hypervisors.

This options specifies the TCP port to use for
live-migration. For Xen, the same port should be
configured on all nodes in
the \fI/etc/xen/xend-config.sxp\fR
file, under the
key ``xend-relocation-port''\&.
.TP
\fBmigration_bandwidth\fR
Valid for the KVM hypervisor.

This option specifies the maximum bandwidth that KVM will
use for instance live migrations. The value is in MiB/s.

This option is only effective with kvm versions >= 78
and qemu-kvm versions >= 0.10.0.
.PP
The \fB--backend-parameters\fR option allows you to set
the default backend parameters for the cluster. The parameter
format is a comma-separated list of key=value pairs with the
following supported keys:
.PP
.TP
\fBvcpus\fR
Number of VCPUs to set for an instance by default, must
be an integer, will be set to 1 if no specified.
.TP
\fBmemory\fR
Amount of memory to allocate for an instance by default,
can be either an integer or an integer followed by a
unit (M for mebibytes and G for gibibytes are
supported), will be set to 128M if not specified.
.TP
\fBauto_balance\fR
Value of the auto_balance flag for instances to use by
default, will be set to true if not specified.
.PP
The \fB--nic-parameters\fR option allows you to set
the default nic parameters for the cluster. The parameter
format is a comma-separated list of key=value pairs with the
following supported keys:
.TP
\fBmode\fR
The default nic mode, 'routed' or 'bridged'.
.TP
\fBlink\fR
In bridged mode the default NIC bridge. In routed mode it
represents an hypervisor-vif-script dependent value to allow
different instance groups. For example under the KVM default
network script it is interpreted as a routing table number or
name.
.PP
The option \fB--maintain-node-health\fR allows to
enable/disable automatic maintenance actions on
nodes. Currently these include automatic shutdown of instances
and deactivation of DRBD devices on offline nodes; in the
future it might be extended to automatic removal of unknown
LVM volumes, etc.
.PP
The \fB--uid-pool\fR option initializes the user-id pool.
The \fIuser-id pool definition\fR can contain a
list of user-ids and/or a list of user-id ranges. The parameter format
is a comma-separated list of numeric user-ids or user-id ranges.
The ranges are defined by a lower and higher boundary, separated
by a dash. The boundaries are inclusive.
If the \fB--uid-pool\fR option is not supplied, the
user-id pool is initialized to an empty list. An empty list means that
the user-id pool feature is disabled.
.SS "LIST-TAGS"

\fBlist-tags\fR

.PP
List the tags of the cluster.
.SS "MASTERFAILOVER"

\fBmasterfailover\fR [ \fB--no-voting\fR ]

.PP
Failover the master role to the current node.
.PP
The \fB--no-voting\fR option skips the remote node agreement
checks. This is dangerous, but necessary in some cases (for example
failing over the master role in a 2 node cluster with the original master
down). If the original master then comes up, it won't be able to start
its master daemon because it won't have enough votes, but so won't the
new master, if the master daemon ever needs a restart. You can pass
--no-voting to ganeti-masterd on the new master to solve this problem,
and gnt-cluster redist-conf to make sure the cluster is consistent again.
.SS "MODIFY"

\fBmodify\fR
    [ \fB-g \fIvg-name\fB\fR ]
    [ \fB--no-lvm-storage\fR ]
    [ \fB--enabled-hypervisors
\fIhypervisors\fB\fR ]
    [ \fB--hypervisor-parameters \fIhypervisor\fB:\fIhv-param\fB=\fIvalue\fB [ ,\fIhv-param\fB=\fIvalue\fB\fI ...\fB ]\fR ]
    [ \fB--backend-parameters \fIbe-param\fB=\fIvalue\fB [ ,\fIbe-param\fB=\fIvalue\fB\fI ...\fB ]\fR ]
    [ \fB--nic-parameters \fInic-param\fB=\fIvalue\fB [ ,\fInic-param\fB=\fIvalue\fB\fI ...\fB ]\fR ]
    [ \fB--uid-pool \fIuser-id pool definition\fB\fR ]
    [ \fB--add-uids \fIuser-id pool definition\fB\fR ]
    [ \fB--remove-uids \fIuser-id pool definition\fB\fR ]
    [ \fB-C \fIcandidate_pool_size\fB\fR ]
    [ \fB--maintain-node-health  { yes | no }\fR ]

.PP
Modify the options for the cluster.
.PP
The \fB-g\fR, \fB--no-lvm-storarge\fR,
\fB--enabled-hypervisors\fR,
\fB--hypervisor-parameters\fR,
\fB--backend-parameters\fR,
\fB--nic-parameters\fR,
\fB--maintain-node-health\fR and
\fB--uid-pool\fR options are
described in the \fBinit\fR command.
.PP
The \fB-C\fR option specifies the
candidate_pool_size cluster parameter. This
is the number of nodes that the master will try to keep as
master_candidates\&. For more details about
this role and other node roles, see the \fBganeti\fR(7)\&. If you increase the size, the master will
automatically promote as many nodes as required and possible
to reach the intended number.
.PP
The \fB--add-uids\fR and \fB--remove-uids\fR
options can be used to modify the user-id pool by adding/removing
a list of user-ids or user-id ranges.
.SS "QUEUE"

\fBqueue\fR [ \fBdrain\fR ] [ \fBundrain\fR ] [ \fBinfo\fR ]

.PP
Change job queue properties.
.PP
The \fBdrain\fR option sets the drain flag on the
job queue. No new jobs will be accepted, but jobs already in
the queue will be processed.
.PP
The \fBundrain\fR will unset the drain flag on the
job queue. New jobs will be accepted.
.PP
The \fBinfo\fR option shows the properties of the
job queue.
.SS "WATCHER"

\fBwatcher\fR { \fBpause \fIduration\fB\fR | \fBcontinue\fR | \fBinfo\fR }

.PP
Make the watcher pause or let it continue.
.PP
The \fBpause\fR option causes the watcher to pause for
\fIduration\fR seconds.
.PP
The \fBcontinue\fR option will let the watcher continue.
.PP
The \fBinfo\fR option shows whether the watcher is currently
paused.
.SS "REDIST-CONF"

\fBredist-conf\fR [ \fB--submit\fR ]

.PP
This command forces a full push of configuration files from
the master node to the other nodes in the cluster. This is
normally not needed, but can be run if the
\fBverify\fR complains about configuration
mismatches.
.PP
The \fB--submit\fR option is used to send the job
to the master daemon but not wait for its completion. The job
ID will be shown so that it can be examined via
\fBgnt-job info\fR\&.
.SS "REMOVE-TAGS"

\fBremove-tags\fR [ \fB--from \fIfile\fB\fR ] \fB\fItag\fB\fR\fI ...\fR

.PP
Remove tags from the cluster. If any of the tags are not
existing on the cluster, the entire operation will abort.
.PP
If the \fB--from\fR option is given, the list of
tags will be extended with the contents of that file (each
line becomes a tag). In this case, there is not need to pass
tags on the command line (if you do, both sources will be
used). A file name of - will be interpreted as stdin.
.SS "RENAME"

\fBrename\fR [ \fB-f\fR ] \fB\fIname\fB\fR

.PP
Renames the cluster and in the process updates the master IP
address to the one the new name resolves to. At least one of
either the name or the IP address must be different, otherwise
the operation will be aborted.
.PP
Note that since this command can be dangerous (especially when
run over SSH), the command will require confirmation unless
run with the \fB-f\fR option.
.SS "RENEW-CRYPTO"

\fBrenew-crypto\fR [ \fB-f\fR ]
    [ \fB--new-cluster-certificate\fR ] [ \fB--new-confd-hmac-key\fR ]
    [ \fB--new-rapi-certificate\fR ] [ \fB--rapi-certificate \fIrapi-cert\fB\fR ]

.PP
This command will stop all
Ganeti daemons in the cluster and start them again once the new
certificates and keys are replicated. The options
\fB--new-cluster-certificate\fR and
\fB--new-confd-hmac-key\fR can be used to regenerate the
cluster-internal SSL certificate respective the HMAC key used by
\fBganeti-confd\fR(8)\&. To generate a new self-signed RAPI certificate (used
by \fBganeti-rapi\fR(8)) specify \fB--new-rapi-certificate\fR\&. If
you want to use your own certificate, e.g. one signed by a certificate
authority (CA), pass its filename to
\fB--rapi-certificate\fR\&.
.SS "REPAIR-DISK-SIZES"

\fBrepair-disk-sizes\fR [ \fBinstance\fR\fI ...\fR ]

.PP
This command checks that the recorded size of the given
instance's disks matches the actual size and updates any
mismatches found. This is needed if the Ganeti configuration
is no longer consistent with reality, as it will impact some
disk operations. If no arguments are given, all instances will
be checked.
.PP
Note that only active disks can be checked by this command; in
case a disk cannot be activated it's advised to use
\fBgnt-instance activate-disks --ignore-size ...\fR to
force activation without regard to the
current size.
.PP
When the all disk sizes are consistent, the command will
return no output. Otherwise it will log details about the
inconsistencies in the configuration.
.SS "SEARCH-TAGS"

\fBsearch-tags\fR \fB\fIpattern\fB\fR

.PP
Searches the tags on all objects in the cluster (the cluster
itself, the nodes and the instances) for a given pattern. The
pattern is interpreted as a regular expression and a search
will be done on it (i.e. the given pattern is not anchored to
the beggining of the string; if you want that, prefix the
pattern with ^).
.PP
If no tags are matching the pattern, the exit code of the
command will be one. If there is at least one match, the exit
code will be zero. Each match is listed on one line, the
object and the tag separated by a space. The cluster will be
listed as \fI/cluster\fR, a node will be listed
as
\fI/nodes/name\fR,
and an instance as
\fI/instances/name\fR\&.
Example:

.nf
# gnt-cluster search-tags time
/cluster ctime:2007-09-01
/nodes/node1.example.com mtime:2007-10-04
.fi
.SS "VERIFY"

\fBverify\fR [ \fB--no-nplus1-mem\fR ]

.PP
Verify correctness of cluster configuration. This is safe with
respect to running instances, and incurs no downtime of the
instances.
.PP
If the \fB--no-nplus1-mem\fR option is given, ganeti won't
check whether if it loses a node it can restart all the instances on
their secondaries (and report an error otherwise).
.SS "VERIFY-DISKS"

\fBverify-disks\fR

.PP
The command checks which instances have degraded DRBD disks
and activates the disks of those instances.
.PP
This command is run from the \fBganeti-watcher\fR
tool, which also has a different, complementary algorithm for
doing this check. Together, these two should ensure that DRBD
disks are kept consistent.
.SS "VERSION"

\fBversion\fR

.PP
Show the cluster version.
.SH "REPORTING BUGS"
.PP
Report bugs to  <URL:http://code.google.com/p/ganeti/> or contact the
developers using the ganeti mailing list
<ganeti@googlegroups.com>\&.
.SH "SEE ALSO"
.PP
Ganeti overview and specifications:
\fBganeti\fR(7) (general overview),
\fBganeti-os-interface\fR(7) (guest OS definitions).
.PP
Ganeti commands:
\fBgnt-cluster\fR(8) (cluster-wide commands),
\fBgnt-job\fR(8) (job-related commands),
\fBgnt-node\fR(8) (node-related commands),
\fBgnt-instance\fR(8) (instance commands),
\fBgnt-os\fR(8) (guest OS commands),
\fBgnt-backup\fR(8) (instance import/export commands),
\fBgnt-debug\fR(8) (debug commands).
.PP
Ganeti daemons:
\fBganeti-watcher\fR(8) (automatic instance restarter),
\fBganeti-cleaner\fR(8) (job queue cleaner),
\fBganeti-noded\fR(8) (node daemon),
\fBganeti-masterd\fR(8) (master daemon),
\fBganeti-rapi\fR(8) (remote API daemon).
.SH "COPYRIGHT"
.PP
Copyright (C) 2006, 2007, 2008, 2009 Google Inc. Permission is
granted to copy, distribute and/or modify under the terms of the
GNU General Public License as published by the Free Software
Foundation; either version 2 of the License, or (at your option)
any later version.
.PP
On Debian systems, the complete text of the GNU General Public
License can be found in /usr/share/common-licenses/GPL.
