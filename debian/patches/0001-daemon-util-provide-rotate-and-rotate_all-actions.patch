From 92113d5551ef1bacb17aa66b0facda162bec158a Mon Sep 17 00:00:00 2001
From: Apollon Oikonomopoulos <apoikos@gmail.com>
Date: Tue, 23 Jul 2013 13:09:20 +0300
Subject: [PATCH stable-2.7 1/2] daemon-util: provide rotate and rotate_all
 actions

Modify daemon-util to allow sending SIGHUP to one or all daemons. This is meant
as a utility function to be used in logrotate definitions.

Signed-off-by: Apollon Oikonomopoulos <apoikos@gmail.com>
Forwarded: yes
Last-Update: 2013-07-23
---
 daemons/daemon-util.in |   28 ++++++++++++++++++++++++++++
 1 file changed, 28 insertions(+)

diff --git a/daemons/daemon-util.in b/daemons/daemon-util.in
index 9481dc0..1d54979 100644
--- a/daemons/daemon-util.in
+++ b/daemons/daemon-util.in
@@ -311,6 +311,34 @@ stop_all() {
   done
 }
 
+# SIGHUP a process to force re-opening its logfiles
+rotate() {
+  if [[ "$#" -lt 1 ]]; then
+    echo 'Missing daemon name.' >&2
+    return 1
+  fi
+
+  local name="$1"; shift
+  local pidfile=$(_daemon_pidfile $name)
+  local daemonexec=$(_daemon_executable $name)
+
+  if type -p start-stop-daemon >/dev/null; then
+    start-stop-daemon --stop --signal HUP --quiet \
+      --pidfile $pidfile
+  else
+    _ignore_error killproc \
+      -p $pidfile \
+      $daemonexec -HUP
+  fi
+}
+
+# SIGHUP all processes
+rotate_all() {
+  for i in $(list_stop_daemons); do
+    rotate $i
+  done
+}
+
 # Reloads the SSH keys
 reload_ssh_keys() {
   @RPL_SSH_INITD_SCRIPT@ restart
-- 
1.7.10.4

