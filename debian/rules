#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# This file is public domain software, originally written by Joey Hess.
#

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

GANETI_DIR=$(CURDIR)/debian/ganeti2
HTOOLS_DIR=$(CURDIR)/debian/ganeti-htools
HASKELL_DIR=$(CURDIR)/debian/ganeti-haskell
PRIVATE_DIR=$(GANETI_DIR)/usr/share/ganeti2

%:
	dh $@ --with python2

override_dh_auto_configure:
	./configure \
	  --prefix=/usr \
	  --localstatedir=/var \
	  --sysconfdir=/etc \
	  --with-export-dir=/var/lib/ganeti/export \
	  --with-iallocator-search-path=/usr/local/lib/ganeti/iallocators,/usr/lib/ganeti/iallocators \
	  --with-os-search-path=/srv/ganeti/os,/usr/local/lib/ganeti/os,/usr/lib/ganeti/os,/usr/share/ganeti/os \
	  --docdir=/usr/share/doc/ganeti2 \
	  --enable-htools --enable-htools-rapi --enable-restricted-commands

override_dh_auto_clean:
	[ ! -f Makefile ] || $(MAKE) distclean
	# this is not removed by make distclean :(
	rm -f ganeti

	rm -f debian/ganeti2.ganeti.init
	rm -f debian/ganeti2.ganeti.cron.d
	rm -f debian/ganeti2.ganeti.default

	dh_auto_clean

override_dh_auto_install:
	$(MAKE) install DESTDIR=$(GANETI_DIR)
	cp $(CURDIR)/doc/examples/ganeti.initd $(CURDIR)/debian/ganeti2.ganeti.init
	cp $(CURDIR)/doc/examples/ganeti.cron $(CURDIR)/debian/ganeti2.ganeti.cron.d
	cp $(CURDIR)/doc/examples/ganeti.default $(CURDIR)/debian/ganeti2.ganeti.default

	install -m 0644 $(CURDIR)/doc/examples/bash_completion \
	  $(GANETI_DIR)/etc/bash_completion.d/ganeti
	install -m 0644 $(CURDIR)/debian/ganeti2.overrides \
	  $(GANETI_DIR)/usr/share/lintian/overrides/ganeti2

	rmdir $(GANETI_DIR)/var/run/ganeti
	rmdir $(GANETI_DIR)/var/run

	# htools
	mv $(GANETI_DIR)/usr/bin $(HTOOLS_DIR)/usr/
	mv $(GANETI_DIR)/usr/lib/ganeti/iallocators/hail \
	   $(HTOOLS_DIR)/usr/lib/ganeti/iallocators/

	for i in htools hail hbal hscan hspace hcheck hinfo hroller; do \
	  mv $(GANETI_DIR)/usr/share/man/man1/$${i}.1 \
	     $(HTOOLS_DIR)/usr/share/man/man1/ ; \
	done
	rmdir $(GANETI_DIR)/usr/share/man/man1

        # haskell package
	mv $(GANETI_DIR)/usr/sbin/ganeti-confd $(HASKELL_DIR)/usr/sbin/
	mv $(GANETI_DIR)/usr/lib/ganeti/mon-collector $(HASKELL_DIR)/usr/lib/ganeti/
	mv $(GANETI_DIR)/usr/share/man/man8/ganeti-confd.8 $(HASKELL_DIR)/usr/share/man/man8/
	mv $(GANETI_DIR)/usr/share/man/man7/mon-collector.7 $(HASKELL_DIR)/usr/share/man/man7/

	# move the python libraries to the private module path
	mv $(GANETI_DIR)/usr/lib/$$(pyversions -d)/dist-packages/ganeti $(GANETI_DIR)/usr/share/ganeti2/
	for file in $(GANETI_DIR)/usr/sbin/*; do \
	  mv $$file $(PRIVATE_DIR); \
	  ln -s ../share/ganeti2/$$(basename $$file) $$file; \
	done

	# ditto for all python tools needing internal APIs
	for file in burnin cfgshell cfgupgrade cfgupgrade12 cluster-merge confd-client lvmstrap move-instance ovfconverter sanitize-config; do \
	  mv $(GANETI_DIR)/usr/lib/ganeti/tools/$$file $(PRIVATE_DIR); \
	  ln -s ../../../share/ganeti2/$$file $(GANETI_DIR)/usr/lib/ganeti/tools/$$file; \
	done

	for file in check-cert-expired ensure-dirs import-export node-daemon-setup prepare-node-join; do \
	  mv $(GANETI_DIR)/usr/lib/ganeti/$$file $(PRIVATE_DIR); \
	  ln -s ../../share/ganeti2/$$file $(GANETI_DIR)/usr/lib/ganeti/$$file; \
	done

override_dh_installinit:
	dh_installinit --name=ganeti --error-handler=true -i -- defaults 20 80

override_dh_installcron:
	dh_installcron --name=ganeti -i
